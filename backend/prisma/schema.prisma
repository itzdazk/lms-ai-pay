// Prisma Schema for LMS AI Pay
// Generated from db_schema.txt

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================
// 1. USERS
// =====================================================
model User {
  id                     Int       @id @default(autoincrement())
  userName               String    @unique @map("username") @db.VarChar(50) // *
  email                  String    @unique @db.VarChar(100)
  passwordHash           String    @map("password_hash") @db.VarChar(255)
  fullName               String    @map("full_name") @db.VarChar(100)
  avatarUrl              String?   @map("avatar_url") @db.VarChar(255)
  phone                  String?   @db.VarChar(20)
  bio                    String?   @db.Text
  role                   String    @default("student") @db.VarChar(20)
  status                 String    @default("active") @db.VarChar(20)
  emailVerified          Boolean   @default(false) @map("email_verified")
  emailVerificationToken String?   @map("email_verification_token") @db.VarChar(255)
  emailVerifiedAt        DateTime? @map("email_verified_at") @db.Timestamptz
  passwordResetToken     String?   @map("password_reset_token") @db.VarChar(255)
  passwordResetExpires   DateTime? @map("password_reset_expires") @db.Timestamptz
  tokenVersion           Int       @default(0) @map("token_version") // new field
  lastLoginAt            DateTime? @map("last_login_at") @db.Timestamptz
  createdAt              DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt              DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  coursesAsInstructor Course[]           @relation("CourseInstructor")
  enrollments         Enrollment[]
  orders              Order[]
  progress            Progress[]
  quizSubmissions     QuizSubmission[]
  aiRecommendations   AiRecommendation[]
  conversations       Conversation[]
  notifications       Notification[]
  userSessions        UserSession[]
  lessonNotes         LessonNote[]

  @@index([email])
  @@index([userName])
  @@index([role])
  @@index([status])
  @@index([emailVerificationToken])
  @@index([passwordResetToken])
  @@map("users")
}

// =====================================================
// 2. CATEGORIES
// =====================================================
model Category {
  id          Int        @id @default(autoincrement())
  name        String     @db.VarChar(100)
  slug        String     @unique @db.VarChar(100)
  description String?    @db.Text
  imageUrl    String?    @map("image_url") @db.VarChar(255)
  parentId    Int?       @map("parent_id")
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    Category[] @relation("CategoryHierarchy")
  sortOrder   Int        @default(0) @map("sort_order")
  isActive    Boolean    @default(true) @map("is_active")
  createdAt   DateTime   @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime   @updatedAt @map("updated_at") @db.Timestamptz

  courses Course[]

  @@index([parentId])
  @@index([slug])
  @@index([isActive])
  @@map("categories")
}

// =====================================================
// 3. TAGS
// =====================================================
model Tag {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(50)
  slug        String   @unique @db.VarChar(50)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz

  courses CourseTag[]

  @@index([slug])
  @@map("tags")
}

// =====================================================
// 4. COURSES
// =====================================================
model Course {
  id                   Int       @id @default(autoincrement())
  title                String    @db.VarChar(200)
  slug                 String    @unique @db.VarChar(200)
  description          String?   @db.Text
  shortDescription     String?   @map("short_description") @db.VarChar(500)
  thumbnailUrl         String?   @map("thumbnail_url") @db.VarChar(255)
  videoPreviewUrl      String?   @map("video_preview_url") @db.VarChar(255)
  videoPreviewDuration Int?      @map("video_preview_duration")
  price                Decimal   @default(0) @db.Decimal(10, 2)
  discountPrice        Decimal?  @map("discount_price") @db.Decimal(10, 2)
  instructorId         Int       @map("instructor_id")
  instructor           User      @relation("CourseInstructor", fields: [instructorId], references: [id])
  categoryId           Int       @map("category_id")
  category             Category  @relation(fields: [categoryId], references: [id])
  level                String?   @db.VarChar(20)
  durationHours        Int       @default(0) @map("duration_hours")
  totalLessons         Int       @default(0) @map("total_lessons")
  language             String    @default("vi") @db.VarChar(10)
  requirements         String?   @db.Text
  whatYouLearn         String?   @map("what_you_learn") @db.Text
  courseObjectives     String?   @map("course_objectives") @db.Text
  targetAudience       String?   @map("target_audience") @db.Text
  status               String    @default("draft") @db.VarChar(20)
  isFeatured           Boolean   @default(false) @map("is_featured")
  ratingAvg            Decimal   @default(0) @map("rating_avg") @db.Decimal(2, 1)
  ratingCount          Int       @default(0) @map("rating_count")
  enrolledCount        Int       @default(0) @map("enrolled_count")
  viewsCount           Int       @default(0) @map("views_count")
  completionRate       Decimal   @default(0) @map("completion_rate") @db.Decimal(5, 2)
  publishedAt          DateTime? @map("published_at") @db.Timestamptz
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  courseTags        CourseTag[]
  chapters          Chapter[]
  lessons           Lesson[]
  enrollments       Enrollment[]
  orders            Order[]
  quizzes           Quiz[]
  aiRecommendations AiRecommendation[]
  conversations     Conversation[]

  @@index([slug])
  @@index([instructorId])
  @@index([categoryId])
  @@index([status])
  @@index([publishedAt])
  @@index([ratingAvg])
  @@index([enrolledCount])
  @@map("courses")
}

// =====================================================
// 4.1. COURSE_TAGS (Many-to-Many)
// =====================================================
model CourseTag {
  courseId Int    @map("course_id")
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  tagId    Int    @map("tag_id")
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([courseId, tagId])
  @@index([courseId])
  @@index([tagId])
  @@map("course_tags")
}

// =====================================================
// 4.2. CHAPTERS (Modules)
// =====================================================
model Chapter {
  id           Int      @id @default(autoincrement())
  courseId     Int      @map("course_id")
  course       Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  title        String   @db.VarChar(200)
  slug         String   @db.VarChar(200)
  description  String?  @db.Text
  chapterOrder Int      @map("chapter_order")
  isPublished  Boolean  @default(true) @map("is_published")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz

  lessons Lesson[]

  @@unique([courseId, slug])
  @@index([courseId])
  @@index([courseId, chapterOrder])
  @@index([isPublished])
  @@map("chapters")
}

// =====================================================
// 5. LESSONS
// =====================================================
model Lesson {
  id                Int      @id @default(autoincrement())
  courseId          Int      @map("course_id")
  course            Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  chapterId         Int?     @map("chapter_id")
  chapter           Chapter? @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  title             String   @db.VarChar(200)
  slug              String   @db.VarChar(200)
  description       String?  @db.Text
  content           String?  @db.Text
  videoUrl          String?  @map("video_url") @db.VarChar(255)
  videoDuration     Int?     @map("video_duration")
  transcriptUrl     String?  @map("transcript_url") @db.VarChar(255)
  transcriptStatus  String   @default("idle") @map("transcript_status") @db.VarChar(20)
  transcriptJsonUrl String?  @map("transcript_json_url") @db.VarChar(255)
  lessonOrder       Int      @map("lesson_order")
  isPreview         Boolean  @default(false) @map("is_preview")
  isPublished       Boolean  @default(true) @map("is_published")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz

  progress      Progress[]
  quizzes       Quiz[]
  conversations Conversation[]
  lessonNotes   LessonNote[]

  @@unique([courseId, slug])
  @@index([courseId])
  @@index([chapterId])
  @@index([chapterId, lessonOrder])
  @@index([courseId, lessonOrder])
  @@index([isPublished])
  @@map("lessons")
}

// =====================================================
// 6. ENROLLMENTS
// =====================================================
model Enrollment {
  id                 Int       @id @default(autoincrement())
  userId             Int       @map("user_id")
  user               User      @relation(fields: [userId], references: [id])
  courseId           Int       @map("course_id")
  course             Course    @relation(fields: [courseId], references: [id])
  enrolledAt         DateTime  @default(now()) @map("enrolled_at") @db.Timestamptz
  startedAt          DateTime? @map("started_at") @db.Timestamptz
  completedAt        DateTime? @map("completed_at") @db.Timestamptz
  progressPercentage Decimal   @default(0) @map("progress_percentage") @db.Decimal(5, 2)
  lastAccessedAt     DateTime? @map("last_accessed_at") @db.Timestamptz
  expiresAt          DateTime? @map("expires_at") @db.Timestamptz
  status             String    @default("active") @db.VarChar(20)
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@index([status])
  @@index([expiresAt])
  @@map("enrollments")
}

// =====================================================
// 7. ORDERS
// =====================================================
model Order {
  id             Int       @id @default(autoincrement())
  userId         Int       @map("user_id")
  user           User      @relation(fields: [userId], references: [id])
  courseId       Int       @map("course_id")
  course         Course    @relation(fields: [courseId], references: [id])
  orderCode      String    @unique @map("order_code") @db.VarChar(50)
  originalPrice  Decimal   @map("original_price") @db.Decimal(10, 2)
  discountAmount Decimal   @default(0) @map("discount_amount") @db.Decimal(10, 2)
  finalPrice     Decimal   @map("final_price") @db.Decimal(10, 2)
  paymentMethod  String?   @map("payment_method") @db.VarChar(50)
  paymentGateway String    @map("payment_gateway") @db.VarChar(50)
  paymentStatus  String    @default("pending") @map("payment_status") @db.VarChar(20)
  transactionId  String?   @unique @map("transaction_id") @db.VarChar(255)
  refundAmount   Decimal   @default(0) @map("refund_amount") @db.Decimal(10, 2)
  refundedAt     DateTime? @map("refunded_at") @db.Timestamptz
  paidAt         DateTime? @map("paid_at") @db.Timestamptz
  billingAddress Json?     @map("billing_address")
  notes          String?   @db.Text
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  paymentTransactions PaymentTransaction[]

  @@index([userId])
  @@index([courseId])
  @@index([orderCode])
  @@index([paymentStatus])
  @@index([transactionId])
  @@index([paymentGateway])
  @@index([paidAt])
  @@map("orders")
}

// =====================================================
// 8. PAYMENT_TRANSACTIONS
// =====================================================
model PaymentTransaction {
  id              Int      @id @default(autoincrement())
  orderId         Int      @map("order_id")
  order           Order    @relation(fields: [orderId], references: [id])
  transactionId   String?  @unique @map("transaction_id") @db.VarChar(100)
  paymentGateway  String   @map("payment_gateway") @db.VarChar(50)
  amount          Decimal  @db.Decimal(10, 2)
  currency        String   @default("VND") @db.VarChar(10)
  status          String?  @db.VarChar(20)
  gatewayResponse Json?    @map("gateway_response")
  errorMessage    String?  @map("error_message") @db.Text
  ipAddress       String?  @map("ip_address") @db.VarChar(45)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz

  @@index([orderId])
  @@index([transactionId])
  @@index([status])
  @@index([paymentGateway])
  @@map("payment_transactions")
}

// =====================================================
// 9. PROGRESS
// =====================================================
model Progress {
  id            Int       @id @default(autoincrement())
  userId        Int       @map("user_id")
  user          User      @relation(fields: [userId], references: [id])
  lessonId      Int       @map("lesson_id")
  lesson        Lesson    @relation(fields: [lessonId], references: [id])
  courseId      Int       @map("course_id")
  isCompleted   Boolean   @default(false) @map("is_completed")
  completedAt   DateTime? @map("completed_at") @db.Timestamptz
  watchDuration Int       @default(0) @map("watch_duration")
  lastPosition  Int       @default(0) @map("last_position")
  attemptsCount Int       @default(0) @map("attempts_count")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
  @@index([courseId])
  @@index([isCompleted])
  @@map("progress")
}

// =====================================================
// 10. NOTIFICATIONS
// =====================================================
model Notification {
  id          Int       @id @default(autoincrement())
  userId      Int       @map("user_id")
  user        User      @relation(fields: [userId], references: [id])
  type        String    @db.VarChar(50)
  title       String    @db.VarChar(200)
  message     String    @db.Text
  relatedId   Int?      @map("related_id")
  relatedType String?   @map("related_type") @db.VarChar(50)
  isRead      Boolean   @default(false) @map("is_read")
  readAt      DateTime? @map("read_at") @db.Timestamptz
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz

  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([createdAt])
  @@map("notifications")
}

// =====================================================
// 11. QUIZZES
// =====================================================
model Quiz {
  id               Int      @id @default(autoincrement())
  lessonId         Int?     @map("lesson_id")
  lesson           Lesson?  @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  courseId         Int?     @map("course_id")
  course           Course?  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  title            String   @db.VarChar(200)
  description      String?  @db.Text
  questions        Json
  passingScore     Int      @default(70) @map("passing_score")
  attemptsAllowed  Int      @default(1) @map("attempts_allowed")
  timeLimitMinutes Int?     @map("time_limit_minutes")
  isPublished      Boolean  @default(true) @map("is_published")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz

  submissions QuizSubmission[]

  @@index([lessonId])
  @@index([courseId])
  @@index([isPublished])
  @@map("quizzes")
}

// =====================================================
// 11.1. QUIZ_SUBMISSIONS
// =====================================================
model QuizSubmission {
  id          Int       @id @default(autoincrement())
  userId      Int       @map("user_id")
  user        User      @relation(fields: [userId], references: [id])
  quizId      Int       @map("quiz_id")
  quiz        Quiz      @relation(fields: [quizId], references: [id])
  answers     Json
  score       Decimal?  @db.Decimal(5, 2)
  isPassed    Boolean?  @map("is_passed")
  startedAt   DateTime? @map("started_at") @db.Timestamptz
  submittedAt DateTime  @default(now()) @map("submitted_at") @db.Timestamptz

  @@index([userId])
  @@index([quizId])
  @@index([submittedAt])
  @@index([startedAt])
  @@map("quiz_submissions")
}

// =====================================================
// 12. AI_RECOMMENDATIONS
// =====================================================
model AiRecommendation {
  id                 Int      @id @default(autoincrement())
  userId             Int      @map("user_id")
  user               User     @relation(fields: [userId], references: [id])
  courseId           Int      @map("course_id")
  course             Course   @relation(fields: [courseId], references: [id])
  recommendationType String?  @map("recommendation_type") @db.VarChar(50)
  score              Decimal? @db.Decimal(5, 2)
  reason             String?  @db.Text
  isViewed           Boolean  @default(false) @map("is_viewed")
  isEnrolled         Boolean  @default(false) @map("is_enrolled")
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@index([userId])
  @@index([courseId])
  @@index([score(sort: Desc)])
  @@map("ai_recommendations")
}

// =====================================================
// 13. CONVERSATIONS
// =====================================================
model Conversation {
  id            Int       @id @default(autoincrement())
  userId        Int       @map("user_id")
  user          User      @relation(fields: [userId], references: [id])
  courseId      Int?      @map("course_id")
  course        Course?   @relation(fields: [courseId], references: [id])
  lessonId      Int?      @map("lesson_id")
  lesson        Lesson?   @relation(fields: [lessonId], references: [id])
  title         String?   @db.VarChar(200)
  aiModel       String    @default("gpt-4") @map("ai_model") @db.VarChar(50)
  contextType   String?   @map("context_type") @db.VarChar(50)
  isActive      Boolean   @default(true) @map("is_active")
  isArchived    Boolean   @default(false) @map("is_archived")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  lastMessageAt DateTime? @map("last_message_at") @db.Timestamptz

  messages ChatMessage[]

  @@index([userId])
  @@index([courseId])
  @@index([lessonId])
  @@index([isActive])
  @@index([lastMessageAt])
  @@map("conversations")
}

// =====================================================
// 14. CHAT_MESSAGES
// =====================================================
model ChatMessage {
  id             Int          @id @default(autoincrement())
  conversationId Int          @map("conversation_id")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderType     String       @map("sender_type") @db.VarChar(20)
  message        String       @db.Text
  messageType    String       @default("text") @map("message_type") @db.VarChar(20)
  attachments    Json?
  metadata       Json?
  isHelpful      Boolean?     @map("is_helpful")
  feedbackText   String?      @map("feedback_text") @db.Text
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamptz

  @@index([conversationId])
  @@index([senderType])
  @@index([createdAt])
  @@index([isHelpful])
  @@map("chat_messages")
}

// =====================================================
// 15. USER SESSIONS
// =====================================================
model UserSession {
  id             String   @id @default(uuid()) @db.Text
  userId         Int      @map("user_id")
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  deviceId       String?  @map("device_id") @db.VarChar(255)
  deviceName     String?  @map("device_name") @db.VarChar(255)
  ipAddress      String?  @map("ip_address") @db.VarChar(45)
  userAgent      String?  @map("user_agent") @db.Text
  isActive       Boolean  @default(true) @map("is_active")
  lastActivityAt DateTime @default(now()) @map("last_activity_at") @db.Timestamptz
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz
  expiresAt      DateTime @map("expires_at") @db.Timestamptz

  @@index([userId])
  @@index([userId, isActive])
  @@index([expiresAt])
  @@map("user_sessions")
}

// =====================================================
// 16. LESSON NOTES
// =====================================================
model LessonNote {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessonId  Int      @map("lesson_id")
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  courseId  Int      @map("course_id")
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
  @@index([courseId])
  @@index([createdAt])
  @@map("lesson_notes")
}
